# tRPCからOpenAPIへの移行 - 変更規模分析

## 📊 現状の規模

### バックエンド
- **総ファイル数**: 15ファイル
- **tRPC関連ファイル**: 7ファイル
- **tRPC関連コード行数**: 約418行
- **削除対象ファイル**:
  - `routers/index.ts` (14行)
  - `routers/signin.ts` (142行)
  - `routers/user.ts` (136行)
  - `routers/video.ts` (128行)
  - `utils/createContext.ts` (18行)
  - `utils/verifyAuth.ts` (29行)
  - `server.ts` の一部 (tRPCプラグイン登録部分)

### フロントエンド
- **総ファイル数**: 29ファイル
- **tRPC使用ファイル**: 8ファイル
- **tRPC使用箇所**: 19箇所
- **影響を受けるファイル**:
  - `providers/TRPCProvider.tsx` (41行)
  - `hooks/useAuth.ts` (37行)
  - `hooks/useS3Image.ts` (72行)
  - `components/VideoList.tsx` (79行)
  - `components/admin/VideoUploadAndDisplay.tsx`
  - `app/page.tsx`
  - `app/layout.tsx`
  - `utils/trpc.ts` (9行)

## 🔄 変更規模の見積もり

### バックエンド変更量

#### 削除するコード
- **削除行数**: 約450行
- **削除ファイル数**: 7ファイル（完全削除: 3ファイル、部分削除: 4ファイル）

#### 新規作成するコード
- **DTO層**: 約200-300行
  - `dto/signin.dto.ts` (~80行)
  - `dto/user.dto.ts` (~100行)
  - `dto/video.dto.ts` (~120行)
  - `dto/index.ts` (~20行)

- **ルート定義**: 約400-500行
  - `routes/signin.routes.ts` (~150行)
  - `routes/user.routes.ts` (~150行)
  - `routes/video.routes.ts` (~200行)
  - `routes/index.ts` (~30行)

- **ミドルウェア**: 約50-80行
  - `middleware/auth.middleware.ts` (~50行)
  - `utils/errorHandler.ts` (~80行)

- **サーバー設定**: 約30-50行（既存ファイルの修正）
  - `server.ts` のOpenAPI統合

**バックエンド新規コード合計**: 約680-930行

### フロントエンド変更量

#### 削除するコード
- **削除行数**: 約200-250行
- **削除ファイル数**: 2ファイル（完全削除）
  - `providers/TRPCProvider.tsx` (41行)
  - `utils/trpc.ts` (9行)

#### 新規作成するコード
- **APIクライアント**: 約150-200行
  - `utils/apiClient.ts` (~150行)

- **APIフック**: 約300-400行
  - `hooks/api/useSignin.ts` (~80行)
  - `hooks/api/useUser.ts` (~100行)
  - `hooks/api/useVideo.ts` (~120行)
  - `hooks/api/index.ts` (~20行)

#### 修正するコード
- **既存フックの置き換え**: 約150-200行
  - `hooks/useAuth.ts` (37行 → 約50行)
  - `hooks/useS3Image.ts` (72行 → 約80行)

- **コンポーネントの修正**: 約100-150行
  - `components/VideoList.tsx` (79行 → 約90行)
  - `components/admin/VideoUploadAndDisplay.tsx` (修正)
  - `app/page.tsx` (修正)
  - `app/layout.tsx` (TRPCProvider削除)

**フロントエンド新規コード合計**: 約450-600行
**フロントエンド修正コード合計**: 約250-350行

## 📈 総合的な変更規模

### コード変更量
- **削除**: 約650-700行
- **新規作成**: 約1,130-1,530行
- **修正**: 約250-350行
- **純増**: 約730-1,180行

### ファイル変更数
- **完全削除**: 5ファイル
- **新規作成**: 約15-18ファイル
- **大幅修正**: 約8-10ファイル
- **軽微修正**: 約3-5ファイル

### 依存関係の変更
- **削除**: 4パッケージ（バックエンド: 2、フロントエンド: 4）
- **追加**: 3-4パッケージ（バックエンド: 3、フロントエンド: 0-1）

## 🎯 変更規模の評価

### 規模レベル: **中規模〜大規模**

#### 理由
1. **アーキテクチャの変更**: tRPCからRESTful APIへの根本的な変更
2. **影響範囲**: バックエンド・フロントエンドの両方に影響
3. **コード量**: 純増約1,000行以上の新規コード
4. **テスト範囲**: 全エンドポイントの再テストが必要

### リスク要因
- **破壊的変更**: 既存のAPI契約が完全に変わる
- **型安全性**: 移行中は型安全性が一時的に低下する可能性
- **並行開発**: 移行中は機能追加が困難

### メリット
- **標準化**: OpenAPIによる標準的なAPI設計
- **ドキュメント**: Swagger UIによる自動ドキュメント生成
- **互換性**: 他システムとの連携が容易
- **スキーマ駆動**: 型安全な開発フローの確立

## ⏱️ 工数見積もり

### 開発工数
- **バックエンド実装**: 5-7日（約40-56時間）
- **フロントエンド実装**: 4-5日（約32-40時間）
- **テスト・デバッグ**: 3-4日（約24-32時間）
- **ドキュメント・クリーンアップ**: 1-2日（約8-16時間）

**合計**: 約13-18日（約104-144時間）

### レビュー・調整
- **コードレビュー**: 2-3日
- **調整・修正**: 2-3日

**総合**: 約17-24日（約136-192時間）

## 📋 変更の複雑度

### 技術的複雑度: **中〜高**

#### 低い複雑度
- Zodスキーマの再利用（既存スキーマをそのまま使用可能）
- 認証ロジックの移行（JWT検証は既存ロジックを流用）

#### 中程度の複雑度
- OpenAPIスキーマの生成（zod-to-openapiの学習が必要）
- エラーハンドリングの統一（HTTPステータスコードのマッピング）

#### 高い複雑度
- フロントエンドの状態管理（React Queryの設定変更）
- 型安全性の維持（OpenAPIからTypeScript型の生成）
- ファイルアップロードの処理（multipart/form-dataの扱い）

## 🚨 注意すべきポイント

1. **段階的移行**: 一度に全てを変更せず、1つのルーターずつ移行
2. **テスト**: 各フェーズで十分なテストを実施
3. **ロールバック計画**: 問題発生時のロールバック手順を準備
4. **ドキュメント**: 移行中の変更を適切に記録

## ✅ 結論

この移行は**中規模〜大規模**な変更となりますが、以下の理由で実行可能です：

1. **明確な計画**: 詳細な実行計画が策定済み
2. **段階的アプローチ**: フェーズごとに進められる
3. **既存資産の活用**: Zodスキーマや認証ロジックを再利用可能
4. **標準化のメリット**: 長期的な保守性の向上

**推奨**: 2-3週間の期間を確保し、段階的に実装を進めることを推奨します。

